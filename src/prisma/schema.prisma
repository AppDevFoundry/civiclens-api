datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider        = "prisma-client-js"
  previewFeatures = []
}

model Article {
  id          Int       @id @default(autoincrement())
  slug        String    @unique
  title       String
  description String
  body        String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @default(now())
  tagList     Tag[]
  author      User      @relation("UserArticles", fields: [authorId], onDelete: Cascade, references: [id])
  authorId    Int
  favoritedBy User[]    @relation("UserFavorites")
  comments    Comment[]
}

model Comment {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())
  body      String
  article   Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)
  articleId Int
  author    User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  authorId  Int
}

model Tag {
  id       Int       @id @default(autoincrement())
  name     String    @unique
  articles Article[]
}

model User {
  id         Int       @id @default(autoincrement())
  email      String    @unique
  username   String    @unique
  password   String
  image      String?   @default("https://api.realworld.io/images/smiley-cyrus.jpeg")
  bio        String?
  articles   Article[] @relation("UserArticles")
  favorites  Article[] @relation("UserFavorites")
  followedBy User[]    @relation("UserFollows")
  following  User[]    @relation("UserFollows")
  comments   Comment[]
  demo       Boolean   @default(false)
  watchlists UserWatchlist[]
  notificationPreferences UserNotificationPreferences?
  notificationHistory     NotificationHistory[]
  devices                 UserDevice[]
  pushPreferences         PushNotificationPreference?
}

// ============================================================================
// Congress.gov API Models
// ============================================================================

/// Congressional bills and legislation
model Bill {
  id                 Int       @id @default(autoincrement())
  congress           Int
  billType           String    // hr, s, hjres, sjres, hconres, sconres, hres, sres
  billNumber         Int
  title              String?
  originChamber      String?   // House, Senate
  originChamberCode  String?   // H, S
  updateDate         DateTime?
  updateDateIncludingText DateTime?
  introducedDate     DateTime?
  latestActionDate   DateTime?
  latestActionText   String?
  policyArea         String?
  constitutionalAuthorityStatementText String?

  // Sponsor information
  sponsorBioguideId  String?
  sponsorFirstName   String?
  sponsorLastName    String?
  sponsorFullName    String?
  sponsorState       String?
  sponsorParty       String?

  // Status and tracking
  lawNumber          String?
  isLaw              Boolean   @default(false)

  // Sync tracking
  lastSyncedAt       DateTime?
  syncAttempts       Int       @default(0)
  lastChangedAt      DateTime?
  priority           Int       @default(5) // 1-10, for sync prioritization

  // Enrichment tracking
  lastEnrichedAt     DateTime?
  enrichmentAttempts Int       @default(0)

  // Metadata
  congressGovUrl     String?
  apiResponseData    Json?     // Store full API response for reference

  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  // Relations
  changeLogs         BillChangeLog[]
  watchlists         UserWatchlist[]
  summary            BillSummary?
  relatedBills       BillRelationship[] @relation("SourceBills")
  relatedFrom        BillRelationship[] @relation("TargetBills")
  notificationHistory NotificationHistory[]

  // Composite unique constraint for Congress.gov bills
  @@unique([congress, billType, billNumber])
  @@index([congress, billType])
  @@index([sponsorBioguideId])
  @@index([updateDate])
  @@index([introducedDate])
  @@index([lastSyncedAt])
  @@index([priority])
}

/// Members of Congress
model Member {
  id                 Int       @id @default(autoincrement())
  bioguideId         String    @unique // Unique identifier from Congress.gov

  // Personal information
  firstName          String?
  middleName         String?
  lastName           String?
  fullName           String?
  nickName           String?
  suffix             String?

  // Current position
  state              String?
  district           Int?      // null for Senators
  party              String?   // D, R, I, etc.
  partyName          String?   // Democratic, Republican, Independent
  chamber            String?   // House, Senate

  // Status
  isCurrent          Boolean   @default(true)

  // Contact and media
  officialWebsiteUrl String?
  imageUrl           String?

  // Dates
  birthYear          Int?

  // Terms served
  terms              Json?     // Array of term objects

  // Metadata
  apiResponseData    Json?

  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  // Relations
  watchlists         UserWatchlist[]
  notificationHistory NotificationHistory[]

  @@index([state])
  @@index([party])
  @@index([chamber])
  @@index([isCurrent])
}

/// Congressional committees
model Committee {
  id                 Int       @id @default(autoincrement())
  systemCode         String    @unique // Unique identifier from Congress.gov (e.g., "hsag00")
  committeeCode      String?   // Chamber-specific code

  name               String
  type               String?   // Standing, Select, Special, Joint
  chamber            String?   // House, Senate, Joint

  isCurrent          Boolean   @default(true)

  // Parent committee for subcommittees
  parentSystemCode   String?

  // Subcommittees stored as JSON array
  subcommittees      Json?

  // Metadata
  congressGovUrl     String?
  apiResponseData    Json?

  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  hearings           Hearing[]

  @@index([chamber])
  @@index([isCurrent])
  @@index([parentSystemCode])
}

/// Presidential nominations
model Nomination {
  id                 Int       @id @default(autoincrement())
  congress           Int
  nominationNumber   String
  partNumber         String?

  // Nominee information
  citation           String?
  description        String?
  organization       String?

  // Status
  latestActionDate   DateTime?
  latestActionText   String?

  // Metadata
  receivedDate       DateTime?
  congressGovUrl     String?
  apiResponseData    Json?

  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  @@unique([congress, nominationNumber])
  @@index([congress])
  @@index([organization])
}

/// Committee hearings
model Hearing {
  id                 Int       @id @default(autoincrement())
  congress           Int
  chamber            String    // House, Senate, Joint
  jacketNumber       String?   // Unique identifier from Congress.gov

  title              String

  // Date and location
  date               DateTime?
  location           String?

  // Associated committee
  committeeCode      String?
  committee          Committee? @relation(fields: [committeeSystemCode], references: [systemCode])
  committeeSystemCode String?

  // Metadata
  congressGovUrl     String?
  apiResponseData    Json?

  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  @@index([congress])
  @@index([chamber])
  @@index([date])
  @@index([committeeSystemCode])
}

// ============================================================================
// Sync & Change Tracking Models
// ============================================================================

/// Track all sync executions for observability
model SyncRun {
  id                  Int       @id @default(autoincrement())
  resourceType        String    // "bills", "members", "hearings", "committees", "nominations"
  status              String    // "queued", "running", "completed", "failed", "partial"
  startedAt           DateTime  @default(now())
  completedAt         DateTime?
  recordsFetched      Int       @default(0)
  recordsCreated      Int       @default(0)
  recordsUpdated      Int       @default(0)
  recordsUnchanged    Int       @default(0)
  errorsEncountered   Json?     // Array of error objects
  cursor              Json?     // Resume token for pagination
  metadata            Json?     // Flexible stats (API calls, rate limits, etc.)

  @@index([resourceType, startedAt])
  @@index([status, startedAt])
}

/// Job queue for background processing
model SyncJob {
  id              Int       @id @default(autoincrement())
  jobType         String    // "sync_bills", "sync_member", "sync_hearing", "generate_summary"
  payload         Json      // Job parameters (congress, dateRange, billId, etc.)
  status          String    @default("pending") // "pending", "processing", "completed", "failed"
  priority        Int       @default(5) // 1-10, higher = more important
  attempts        Int       @default(0)
  maxAttempts     Int       @default(3)
  scheduledFor    DateTime  @default(now())
  startedAt       DateTime?
  completedAt     DateTime?
  error           String?   @db.Text
  result          Json?     // Job result data

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([status, scheduledFor, priority])
  @@index([jobType, status])
  @@index([createdAt])
}

/// Track changes to bills for notifications
model BillChangeLog {
  id            Int      @id @default(autoincrement())
  billId        Int
  bill          Bill     @relation(fields: [billId], references: [id], onDelete: Cascade)
  changeType    String   // "status", "action", "cosponsors", "summary", "title"
  previousValue Json?    // Old value (flexible structure)
  newValue      Json?    // New value (flexible structure)
  detectedAt    DateTime @default(now())
  notified      Boolean  @default(false)

  @@index([billId, detectedAt])
  @@index([notified, detectedAt])
  @@index([changeType, detectedAt])
}

// ============================================================================
// User Engagement Models
// ============================================================================

/// User watchlists for bills, members, and topics
model UserWatchlist {
  id              Int       @id @default(autoincrement())
  userId          Int
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // What they're watching (one of these will be set)
  billId          Int?
  bill            Bill?     @relation(fields: [billId], references: [id], onDelete: Cascade)
  memberId        Int?
  member          Member?   @relation(fields: [memberId], references: [id], onDelete: Cascade)
  topicKeyword    String?   // e.g., "privacy", "healthcare", "AI"

  // Notification preferences
  notifyOnStatus      Boolean @default(true)
  notifyOnActions     Boolean @default(true)
  notifyOnCosponsors  Boolean @default(false)
  digestMode          Boolean @default(false) // Daily digest vs real-time

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  lastNotifiedAt  DateTime?

  @@unique([userId, billId])
  @@unique([userId, memberId])
  @@index([userId, topicKeyword])
  @@index([billId])
  @@index([memberId])
}

/// User notification preferences (global settings)
model UserNotificationPreferences {
  id                    Int      @id @default(autoincrement())
  userId                Int      @unique
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Global notification settings
  emailEnabled          Boolean  @default(true)
  emailAddress          String?  // Override user.email if set
  digestFrequency       String   @default("daily") // "instant", "daily", "weekly", "never"
  digestTime            String   @default("08:00") // "HH:MM" format (user's timezone)
  timezone              String   @default("America/New_York")

  // Unsubscribe
  unsubscribeToken      String   @unique @default(uuid())
  unsubscribedAt        DateTime?

  // Email verification
  emailVerified         Boolean  @default(false)
  emailVerificationToken String?  @unique
  emailVerifiedAt       DateTime?

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([emailEnabled])
  @@index([unsubscribeToken])
}

/// Track notification history
model NotificationHistory {
  id                Int      @id @default(autoincrement())
  userId            Int
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Notification details
  notificationType  String   // "bill_change", "member_update", "digest"
  subject           String
  body              String   @db.Text

  // Related entities
  billId            Int?
  bill              Bill?    @relation(fields: [billId], references: [id], onDelete: SetNull)
  memberId          Int?
  member            Member?  @relation(fields: [memberId], references: [id], onDelete: SetNull)
  changeLogId       Int?

  // Delivery details
  deliveryMethod    String   @default("email") // "email", "push", "sms"
  recipientEmail    String
  status            String   @default("pending") // "pending", "sent", "failed", "bounced"
  sentAt            DateTime?
  failedAt          DateTime?
  error             String?

  // Engagement tracking
  opened            Boolean  @default(false)
  openedAt          DateTime?
  clicked           Boolean  @default(false)
  clickedAt         DateTime?

  createdAt         DateTime @default(now())

  @@index([userId, createdAt])
  @@index([status])
  @@index([notificationType])
  @@index([billId])
}

// ============================================================================
// AI Enhancement Models
// ============================================================================

/// AI-generated plain-language summaries for bills
model BillSummary {
  id                    Int      @id @default(autoincrement())
  billId                Int      @unique
  bill                  Bill     @relation(fields: [billId], references: [id], onDelete: Cascade)

  plainLanguageSummary  String   @db.Text // "In plain English: ..."
  keyPoints             Json     // Array of bullet points
  stakeholders          Json?    // Array of affected groups
  controversy           String?  @db.Text // Key points of debate
  complexityScore       Int?     // 1-10, how technical/specialized

  generatedAt           DateTime @default(now())
  generatedBy           String   // "gpt-4", "claude-3-5-sonnet", etc.
  tokensUsed            Int?
  cost                  Float?   // USD cost of generation

  @@index([generatedAt])
  @@index([complexityScore])
}

/// Relationships between bills for insights
model BillRelationship {
  id                Int    @id @default(autoincrement())
  sourceBillId      Int
  targetBillId      Int
  relationshipType  String // "companion", "related", "supersedes", "amends", "similar"

  sourceBill        Bill   @relation("SourceBills", fields: [sourceBillId], references: [id], onDelete: Cascade)
  targetBill        Bill   @relation("TargetBills", fields: [targetBillId], references: [id], onDelete: Cascade)

  confidence        Float? // 0-1, if detected via ML/similarity
  source            String @default("congress_api") // "congress_api", "detected", "manual"
  metadata          Json?  // Additional relationship context

  createdAt         DateTime @default(now())

  @@unique([sourceBillId, targetBillId, relationshipType])
  @@index([sourceBillId])
  @@index([targetBillId])
  @@index([relationshipType])
}

// ============================================================================
// Error Tracking Models
// ============================================================================

/// Tracks sync errors for monitoring and debugging
model SyncError {
  id          Int      @id @default(autoincrement())
  errorType   String   // "retryable", "fatal", "transient", etc.
  severity    String   // "low", "medium", "high", "critical"
  message     String
  stackTrace  String?  @db.Text
  context     Json?    // Additional error context
  shouldAlert Boolean  @default(false)
  alerted     Boolean  @default(false)
  alertedAt   DateTime?
  resolved    Boolean  @default(false)
  resolvedAt  DateTime?
  resolvedBy  String?  // User who marked as resolved
  notes       String?  @db.Text
  createdAt   DateTime @default(now())

  @@index([errorType])
  @@index([severity])
  @@index([createdAt])
  @@index([shouldAlert, alerted])
}

// ============================================================================
// Push Notification Models
// ============================================================================

/// User devices for push notifications (iOS/Android)
model UserDevice {
  id            Int      @id @default(autoincrement())
  userId        Int
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Device information
  deviceToken   String   @unique     // FCM/APNs registration token
  platform      String                // "ios" | "android"
  deviceName    String?               // Optional user-friendly name
  deviceModel   String?               // "iPhone 14 Pro", "Samsung Galaxy S23", etc.
  osVersion     String?               // "iOS 17.1", "Android 13", etc.
  appVersion    String?               // App version at time of registration

  // Status
  isActive      Boolean  @default(true)
  lastActiveAt  DateTime @default(now())

  // Badge count (iOS)
  badgeCount    Int      @default(0)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([userId])
  @@index([platform])
  @@index([isActive])
  @@index([lastActiveAt])
}

/// Push notification preferences with flexible criteria system
model PushNotificationPreference {
  id                    Int      @id @default(autoincrement())
  userId                Int      @unique
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Global push settings
  pushEnabled           Boolean  @default(true)
  soundEnabled          Boolean  @default(true)
  vibrationEnabled      Boolean  @default(true)

  // Quiet hours
  quietHoursEnabled     Boolean  @default(false)
  quietHoursStart       String?  @default("22:00") // "HH:MM" format
  quietHoursEnd         String?  @default("08:00") // "HH:MM" format
  timezone              String   @default("America/New_York")

  // Rate limiting
  maxNotificationsPerDay Int     @default(20)
  maxNotificationsPerHour Int    @default(5)

  // Criteria-based preferences (flexible JSON for future expansion)
  // These define WHAT triggers push notifications

  // Bill change criteria
  billCriteria          Json?    @db.JsonB
  /* Example structure:
  {
    "watchlistOnly": true,
    "minSignificance": "high", // "high" | "medium" | "low"
    "policyAreas": ["Healthcare", "Defense"],
    "billTypes": ["hr", "s"],
    "specificSponsors": ["A000001", "B000123"],
    "committees": ["HSAG", "SSFI"]
  }
  */

  // Member activity criteria
  memberCriteria        Json?    @db.JsonB
  /* Example structure:
  {
    "watchlistOnly": true,
    "specificMembers": ["A000001"],
    "states": ["CA", "NY"],
    "parties": ["D", "R"],
    "committees": ["HSAG"]
  }
  */

  // Keyword/topic criteria
  keywordCriteria       Json?    @db.JsonB
  /* Example structure:
  {
    "keywords": ["healthcare", "climate change"],
    "exactMatch": false,
    "booleanLogic": "OR" // "OR" | "AND"
  }
  */

  // Timing criteria
  timingCriteria        Json?    @db.JsonB
  /* Example structure:
  {
    "instant": true,
    "allowDigest": false,
    "urgentBypassQuietHours": true
  }
  */

  // Unsubscribe
  unsubscribeToken      String   @unique @default(uuid())
  unsubscribedAt        DateTime?

  // Analytics
  totalNotificationsSent Int     @default(0)
  lastNotificationSentAt DateTime?

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([pushEnabled])
  @@index([userId])
  @@index([unsubscribeToken])
}
